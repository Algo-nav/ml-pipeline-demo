name: Retrain Pipeline

on:
  workflow_dispatch:
    inputs:
      drift_level:
        description: "Drift level for simulated data"
        required: true
        default: "mild"
        type: choice
        options:
          - none
          - mild
          - severe

jobs:
  initial-train:
    name: Initial Training
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install scipy

    - name: Run tests
      run: pytest tests/test_fraud.py -v --tb=short

    - name: Train initial model
      working-directory: src
      run: python fraud_train.py --n_samples 5000 --min_f1 0.5

    - name: Move artifacts
      run: |
        mv src/fraud_artifacts ./fraud_artifacts

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fraud-model
        path: fraud_artifacts/

  retrain:
    name: Retrain & Compare
    runs-on: ubuntu-latest
    needs: initial-train

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install scipy

    - name: Download champion model
      uses: actions/download-artifact@v4
      with:
        name: fraud-model
        path: src/fraud_artifacts/

    - name: Run retraining pipeline
      working-directory: src
      run: |
        python fraud_retrain.py \
          --drift_level ${{ github.event.inputs.drift_level }} \
          --batch_size 1000 \
          --min_improvement 0.01

    - name: Move artifacts
      run: |
        cp -r src/fraud_artifacts ./fraud_artifacts

    - name: Upload retrained artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fraud-model-retrained
        path: fraud_artifacts/

  deploy:
    name: Deploy if Improved
    runs-on: ubuntu-latest
    needs: retrain

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download retrained artifacts
      uses: actions/download-artifact@v4
      with:
        name: fraud-model-retrained
        path: fraud_artifacts/

    - name: Check deploy flag
      id: check_flag
      run: |
        if [ -f fraud_artifacts/deploy_flag ] && [ "$(cat fraud_artifacts/deploy_flag)" = "true" ]; then
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "Deploy flag is TRUE - will deploy"
        else
          echo "should_deploy=false" >> $GITHUB_OUTPUT
          echo "Deploy flag is FALSE - skipping deployment"
        fi

    - name: Set up Python
      if: steps.check_flag.outputs.should_deploy == 'true'
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      if: steps.check_flag.outputs.should_deploy == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install huggingface_hub gradio

    - name: Deploy to HuggingFace
      if: steps.check_flag.outputs.should_deploy == 'true'
      env:
        HF_TOKEN: ${{ secrets.HF_TO1KEN }}
      run: python deploy/deploy_fraud.py

    - name: Skip deployment notice
      if: steps.check_flag.outputs.should_deploy != 'true'
      run: echo "Deployment skipped - champion model retained"
